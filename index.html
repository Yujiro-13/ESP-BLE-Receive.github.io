<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLE Central</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
</head>
<body>
<div id="app">
  <div>
    <h2 class="modal-header">BLE Central</h2>
    <button class="btn btn-primary" v-on:click="ble_connect()" v-if="!ble_isConnected">Connect</button>
    <button class="btn btn-primary" v-on:click="ble_disconnect()" v-else>Disconnect</button>
    <br><br>
    <label class="title">ServiceUUID</label> 
    <input type="text" class="form-control" v-model="ble_target_serviceuuid"><br>
    
    <div>
      <h5 class="card-header">Additional Services</h5>
      <div class="card-body">
        <textarea class="form-control" v-model="ble_additional_services"></textarea>
      </div>
    </div>

    <div v-if="ble_device">
      <label class="title">id</label> {{ble_device.id}}<br>
      <label class="title">name</label> {{ble_device.name}}<br>
    </div>

    <button class="btn btn-secondary" v-on:click="ble_allread()" v-if="ble_isConnected">All Read</button>
    <button class="btn btn-secondary" v-on:click="ble_allnotify()" v-if="ble_isConnected">All Notify</button>
    <br><br>

    <div class="card m-3" v-for="(service, index) in ble_services">
      <h3 class="card-header">{{find_service_name(service.uuid)}}</h3>
      <div class="card-body">
        <label class="title">uuid</label> {{service.uuid}}<br><br>
        <table class="table table-striped">
          <tbody>
            <tr v-for="(characteristic, index) in service.characteristics">
              <td>
                <span data-bs-toggle="tooltip" v-bind:title="characteristic.properties">
                  <label class="title">{{characteristic.uuid}}</label>
                  <span v-if="find_characteristic_name(characteristic.uuid)"><br>{{find_characteristic_name(characteristic.uuid)}}</span>
                </span>
              </td>
              <td>
                <span v-bind:class="{ 'has-success': characteristic.value_changed }">
                  <span data-bs-toggle="tooltip" v-bind:title="ble_toStr(characteristic)">
                    <input type="text" class="form-control" v-model="characteristic.value_hex">
                  </span>
                </span>
              </td>
              <td>
                <button class="btn btn-secondary btn-sm" v-if="characteristic.characteristic.properties.read" v-on:click="value_read(characteristic)">Read</button>
                <button class="btn btn-secondary btn-sm" v-if="characteristic.characteristic.properties.write || characteristic.characteristic.properties.writeWithoutResponse || characteristic.characteristic.properties.authenticatedSignedWrites" v-on:click="value_write(characteristic)">Write</button>
                <button class="btn btn-secondary btn-sm" v-if="characteristic.characteristic.properties.notify" v-on:click="notify_enable(characteristic)"><span v-if="characteristic.notify_enabled">Disable Notify</span><span v-else>Enable Notify</span></button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  var decoder = new TextDecoder('utf-8');

  new Vue({
    el: '#app',
    data: function () {
      return {
        ble_device: null,
        ble_services: [],
        ble_isConnected: false,
        ble_additional_services: '',
        ble_target_serviceuuid: "",
      }
    },
    methods: {
      ble_toStr: function (characteristic) {
        if (!characteristic.characteristic.value) return null;
        return decoder.decode(characteristic.characteristic.value);
      },
      ble_allnotify: async function () {
        for (var i = 0; i < this.ble_services.length; i++) {
          for (var j = 0; j < this.ble_services[i].characteristics.length; j++) {
            var characteristic = this.ble_services[i].characteristics[j];
            if (characteristic.characteristic.properties.notify) {
              this.notify_enable(characteristic, true);
            }
          }
        }
        alert("All notifications started.");
      },
      ble_allread: async function () {
        for (var i = 0; i < this.ble_services.length; i++) {
          for (var j = 0; j < this.ble_services[i].characteristics.length; j++) {
            var characteristic = this.ble_services[i].characteristics[j];
            if (characteristic.characteristic.properties.read) {
              try {
                await characteristic.characteristic.readValue();
                this.$set(characteristic, "value_changed", false);
              } catch (error) {
                console.error(error);
              }
            }
          }
        }
        alert("All values read.");
      },
      ble_disconnect: function () {
        if (this.ble_device != null && this.ble_device.gatt.connected) {
          this.ble_device.gatt.disconnect();
          this.ble_device = null;
          this.ble_services = [];
          this.ble_isConnected = false;
        }
      },
      ble_connect: async function () {
          if (!this.ble_target_serviceuuid) {
            alert('Service UUIDを入力してください。');
            return;
          }

        try {
          this.ble_disconnect();
          var additional_services = [];
          if (this.ble_additional_services) {
            additional_services = this.ble_additional_services.split(/\r\n|\r|\n/);
            for (var i = 0; i < additional_services.length; i++) {
              additional_services[i] = additional_services[i].length <= 4 ? parseInt(additional_services[i], 16) : additional_services[i].toLowerCase();
            }
          }
          var optionalServices = additional_services.concat([parseInt(this.ble_target_serviceuuid)]);
          this.ble_device = await navigator.bluetooth.requestDevice({ filters: [{ services: [this.ble_target_serviceuuid] }] });
        } catch (error) {
          console.error(error);
          alert(error);
          return;
        }

        try {
          this.ble_services = [];
          var server = await this.ble_device.gatt.connect();
          var services = await server.getPrimaryServices();
          var list = [];
          for (var i = 0; i < services.length; i++) {
            var service = await this.ble_setService(services[i]);
            list.push(service);
          }
          this.ble_services = list;
          this.ble_isConnected = true;
          alert("Connected.");
        } catch (error) {
          console.error(error);
          alert(error);
        }
      },
      async ble_setService(service) {
        var item = {
          uuid: service.uuid,
          service: service,
          characteristics: []
        };
        try {
          var characteristics = await service.getCharacteristics();
          for (var i = 0; i < characteristics.length; i++) {
            await this.ble_setupCharacteristic(item.characteristics, characteristics[i]);
          }
        } catch (error) {
          console.error(error);
        }
        return item;
      },
      async ble_setupCharacteristic(characteristics, characteristic) {
        var item = {
          uuid: characteristic.uuid,
          characteristic: characteristic,
        };
        item.properties = "properties:";
        if (characteristic.properties.read) item.properties += " read";
        if (characteristic.properties.writeWithoutResponse) item.properties += " writeWithoutResponse";
        if (characteristic.properties.write) item.properties += " write";
        if (characteristic.properties.notify) item.properties += " notify";
        characteristics.push(item);
        characteristic.addEventListener('characteristicvaluechanged', this.ble_onDataChanged.bind(this.ble_onDataChanged));
      },
      ble_onDataChanged(event) {
        console.log('ble_onDataChanged');
      },
      notify_enable(characteristic, forceEnable = false) {
        if (characteristic.notify_enabled && !forceEnable) {
          characteristic.characteristic.stopNotifications();
          this.$set(characteristic, "notify_enabled", false);
        } else {
          characteristic.characteristic.startNotifications();
          this.$set(characteristic, "notify_enabled", true);
        }
      },
      value_read: async function (characteristic) {
        try {
          await characteristic.characteristic.readValue();
          this.$set(characteristic, "value_changed", false);
        } catch (error) {
          console.error(error);
        }
      },
      value_write: async function (characteristic) {
        try {
          var array = new Uint8Array(characteristic.value_hex.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
          if (characteristic.characteristic.properties.writeWithoutResponse) {
            await characteristic.characteristic.writeValueWithoutResponse(array);
          } else {
            await characteristic.characteristic.writeValueWithResponse(array);
          }
        } catch (error) {
          console.error(error);
        }
      },
      dataview2hex: function (data) {
        return Array.from(new Uint8Array(data.buffer)).map(b => b.toString(16).padStart(2, '0')).join('');
      },
      hex2array: function (hex) {
        return new Uint8Array(hex.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
      },
      uuid128touuid16: function (uuid128) {
        var baseUuid = "00000000-0000-1000-8000-00805f9b34fb";
        if (uuid128.length == 36 && uuid128.endsWith(baseUuid.slice(8))) {
          return parseInt(uuid128.slice(0, 8), 16).toString(16);
        }
        return uuid128;
      },
      find_service_name: function (uuid) {
        return this.uuid128touuid16(uuid);
      },
      find_characteristic_name: function (uuid) {
        return this.uuid128touuid16(uuid);
      },
    }
  });
</script>
</body>
</html>
